<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>HIKE Fault Database</title>
    <meta name="" content="">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://bootswatch.com/4/simplex/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <link rel="stylesheet" href="css/FontAwesome/all.min.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
    <style>
        @charset "utf-8";

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            background: white;
            outline: 10;
        }

        #info-pane {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 400;
            padding: 1em;
            background: white;
        }

        #getFile {
            position: absolute;
            top: 0px;
            right: 0px;
            height: 70px;
            width: 60px;
            z-index: 500;
            background: rgba(255, 255, 255, 0.7);
            font-family: sans-serif;
            font-size: 11px;
            border: 0px;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            z-index: 1000;
            color: aqua;
            width: 3rem;
            height: 3rem;
        }

        .faultLabel {
            font-size: 10px;
            padding: 0px;
            opacity: 1;
        }

        .leaflet-tooltip {
            background-color: rgba(255, 255, 255, .5);
            border: 1px;
        }

        a {
            text-decoration: none;
        }

        .popUpText {
            font-size: 80%;
            line-height: 100%;
            margin-top: -5px;
            margin-bottom: 4px;

        }

        /* .leaflet-tooltip-left:before {
      right: 0;
      margin-right: -12px;
      border-left-color: rgba(0, 0, 0, 0);
    }

    .leaflet-tooltip-right:before {
      left: 0;
      margin-left: -12px;
      border-right-color: rgba(0, 0, 0, 0);
    } */
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="loading" class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
    </div>
    <script>
        let urlParams = new URLSearchParams(window.location.search);
        let USER_LANG = (navigator.language || navigator.language).substring(0, 2);
        //console.log(USER_LANG);

        let URI = 'https://data.geoscience.earth/ncl/geoera/hike/faults/493';
        if (urlParams.has('uri')) {
            //USER_LANG = urlParams.get('lang');
            URI = decodeURI(urlParams.get('uri').replace(/["';><]/gi, ''));
            //console.log(URI);
        } else {

        }

        let map = L.map('map');

        L.tileLayer.wms('https://ows.mundialis.de/services/service?', {
            'layers': 'OSM-WMS',
            'opacity': '0.6',
            'format': 'image/png',
            'attribution': '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>, <a href="https://geoera.eu/projects/hike10/"> GeoERA - HIKE Fault Database</a>'
        }).addTo(map);

        L.tileLayer.wms('https://egditest01.geus.dk/egdi/wms/', {
            'layers': 'hike_faultdb_overview',
            'mapname': 'hike_preview',
            'transparent': 'true',
            'opacity': '0.4',
            'format': 'image/png'
        }).addTo(map);
        //https://data.geoscience.earth/ncl/geoera/hike/faults/493 periadria, 502 Vienna



        let queryDownLoad = encodeURIComponent(`PREFIX dcterms:<http://purl.org/dc/terms/>
            PREFIX geoera:<https://data.geoscience.earth/ncl/geoera/>
            PREFIX skos:<http://www.w3.org/2004/02/skos/core#>
            PREFIX geosparql:<http://www.opengis.net/ont/geosparql#>
            PREFIX foaf:<http://xmlns.com/foaf/0.1/>
            SELECT DISTINCT ?uri (MIN(?L) AS ?label) (MIN(?D) AS ?def) (MIN(?T) AS ?type)
            (COALESCE(GROUP_CONCAT(DISTINCT ?l; separator = ';'),"") as ?links)
            WHERE {
            VALUES ?c {<${URI}>}
            VALUES ?rel {skos:related dcterms:relation geosparql:sfTouches skos:exactMatch skos:closeMatch}
            VALUES ?attr {foaf:page}
            {?c skos:narrower* ?n . BIND(?n AS ?uri) BIND(IF(?n=?c,"", skos:narrower) AS ?T)}
            UNION
            {?c ?rel ?r . BIND(?r AS ?uri) BIND(?rel AS ?T) FILTER(REGEX(STR(?r),"fault"))}
            ?uri skos:prefLabel ?Len . filter(lang(?Len)='en')
            OPTIONAL {?uri skos:prefLabel ?Lx . filter(lang(?Lx)='${USER_LANG}')} BIND(coalesce(?Lx,?Len,"") as ?L)
            OPTIONAL {?uri skos:definition ?Den . filter(lang(?dEN)='Den')}
            OPTIONAL {?uri skos:definition ?Dx . filter(lang(?Dx)='${USER_LANG}')} BIND(coalesce(?Dx,?Den,"") as ?D)
            OPTIONAL {?uri ?attr ?l}
            }
            GROUP BY ?uri`);

        fetch(`https://resource.geolba.ac.at/PoolParty/sparql/geoera?query=${queryDownLoad}&format=application/json`)
            .then(res => res.json())
            .then(jsonData => {

                let selectedURIs = jsonData.results.bindings.map(a => ({
                    id: a.uri.value.split('/').pop(),
                    uri: a.uri.value,
                    type: a.type.value,
                    label: a.label.value,
                    def: a.def.value,
                    links: a.links.value
                }));

                //console.log(selectedURIs);
                let numbers = jsonData.results.bindings
                    .map(a => [a.uri.value.split('/').pop(), a.label.value, a.def.value, a.links.value, a.type
                        .value
                    ]);

                //console.log(numbers);

                let orPart = (selectedURIs.length > 1) ? ['<ogc:Or>', '</ogc:Or>'] : ['', ''];
                let ogcFilter = `<ogc:Filter>
                          ${orPart[0]}
                            <ogc:PropertyIsEqualTo>
                              <ogc:PropertyName>ms:concept_id</ogc:PropertyName>
                              <ogc:Literal>
                              ${selectedURIs.map(a=>a.id).join(`</ogc:Literal>
                                  </ogc:PropertyIsEqualTo>
                                  <ogc:PropertyIsEqualTo>
                                    <ogc:PropertyName>ms:concept_id</ogc:PropertyName>
                                <ogc:Literal>`)}
                              </ogc:Literal>
                            </ogc:PropertyIsEqualTo>
                          ${orPart[1]}
                        </ogc:Filter>`;
                ogcFilter = ogcFilter.replace(/\r?\n|\r|\s/g, "");
                //console.log(ogcFilter);
                //https://egditest01.geus.dk/egdi/wfs/3034/?LAYERS=hike_faultdb_overview_pvtest&SERVICE=WFS&VERSION=1.0.0&REQUEST=GetFeature&TYPENAME=hike_faultdb_overview_pvtest&MAXFEATURES=1000&
                fetch(
                        `https://data.geus.dk/egdi/wfs/3034/?SERVICE=WFS&VERSION=1.0.0&REQUEST=GetFeature&TYPENAME=HIKE_FAULTDB_DETAIL_V12&MAXFEATURES=1000&Filter=${ogcFilter}`
                    )
                    .then(res => res.text())
                    .then(data => {
                        console.log(data); //****************************************original

                        let parser = new DOMParser(),
                            xmlDoc = parser.parseFromString(data, 'text/xml');

                        let showToolTip = true;
                        let labels = $(xmlDoc).find("ms\\:local_name");
                        if ((labels.length - [...new Set(labels.text().split(' '))].length) > 20) {
                            showToolTip = false;
                        }

                        let ext = $(xmlDoc).find("gml\\:coordinates").first().text().split(' ').map(a => a
                            .split(','));

                        try {
                            let setView = [(parseFloat(ext[0][1]) + parseFloat(ext[1][1])) / 2,
                                (parseFloat(ext[0][0]) + parseFloat(ext[1][0])) / 2
                            ];
                            map.setView(setView, 7);
                        } catch (e) {
                            alert('map data not found');
                        }


                        $(xmlDoc).find("gml\\:featureMember")
                            .find("ms\\:HIKE_FAULTDB_DETAIL_V12")
                            .each(function () {
                                let feat = {
                                    ogc_fid: $(this).find("ms\\:ogc_fid").text(),
                                    concept_uri: $(this).find("ms\\:concept_uri").text(),
                                    concept_id: $(this).find("ms\\:concept_id").text(),
                                    local_name: $(this).find("ms\\:local_name").text(),
                                    bounds: $(this).find("gml\\:Box").text(),
                                    geometry: $(this).find("ms\\:msGeometry"),
                                    country_cd: $(this).find("ms\\:country_cd").text(),
                                    fault_type: $(this).find("ms\\:fault_type").text(),
                                    fault_type_uri: $(this).find("ms\\:fault_type_uri").text(),
                                    timing: $(this).find("ms\\:timing").text(),
                                    timing_uri: $(this).find("ms\\:timing_uri").text(),
                                    observ_meth: $(this).find("ms\\:observ_meth").text(),
                                    observ_meth_uri: $(this).find("ms\\:observ_meth_uri").text(),
                                    dip_angle: $(this).find("ms\\:dip_angle").text(),
                                    dip_angle_uri: $(this).find("ms\\:dip_angle_uri").text(),
                                    dip_direct: $(this).find("ms\\:dip_direct").text(),
                                    strike: $(this).find("ms\\:strike").text(),
                                    move_sense: $(this).find("ms\\:move_sense").text(),
                                    move_sense_uri: $(this).find("ms\\:move_sense_uri").text(),
                                    offset_det: $(this).find("ms\\:offset_det").text(),
                                    offset_det_uri: $(this).find("ms\\:offset_det_uri").text(),
                                    ref_surf: $(this).find("ms\\:ref_surf").text(),
                                    ref_surf_uri: $(this).find("ms\\:ref_surf_uri").text(),
                                    scale_from: $(this).find("ms\\:scale_from").text(),
                                    scale_to: $(this).find("ms\\:scale_to").text()
                                };

                                let latlang = [];
                                feat.geometry.each(function () {
                                    let lineArr = $(this).find("gml\\:coordinates").text()
                                        .split(' ').map(a => [parseFloat(a.split(',')[1]),
                                            parseFloat(a.split(',')[0])
                                        ]);
                                    lineArr.pop();
                                    latlang.push(lineArr);
                                });

                                let toolTipLabel = feat.local_name;
                                if (toolTipLabel.length > 25) {
                                    toolTipLabel = toolTipLabel.replace(' Fault', '<br>Fault').replace(
                                        ' Subfault', '<br>Subfault');
                                }
                                //console.log(feat);

                                let selConcept = selectedURIs.find(a => a.id == $(this).find(
                                        "ms\\:concept_id")
                                    .text());
                                //console.log(selConcept);

                                let titleSuffix = ``;

                                try {
                                    let lineStyle = {};
                                    let titlePrefix = '';
                                    switch (selConcept.type) {
                                        case "http://www.opengis.net/ont/geosparql#sfTouches":
                                            lineStyle.color = 'black';
                                            lineStyle.weight = 2;
                                            lineStyle.dashArray = '15, 7';
                                            titleSuffix =
                                                `<h4>a delimitation of ${selectedURIs.find(a => a.type == '').label}</h4>`;
                                            break;
                                        default:
                                            lineStyle.color = 'red';
                                            lineStyle.weight = 5;
                                    }

                                    L.polyline(latlang, lineStyle).addTo(map)
                                        .bindPopup(
                                            `<h2><a href="${feat.concept_uri}" target="_blank">${selConcept.label}</a></h2>${titleSuffix}
                                ${(selConcept.def.length>0)?(`<div class="popUpText">${selConcept.def.substr(0,400)+'..'}</div>`):''}
                                Fault type: <a href="${feat.fault_type_uri}" target="_blank">${feat.fault_type}</a>
                                , Time: <a href="${feat.timing_uri}" target="_blank">${feat.timing}</a><br>
                                Observation method: <a href="${feat.observ_meth_uri}" target="_blank">${feat.observ_meth}</a><br>
                                Dip angle: ${feat.dip_angle}
                                , Dip direction: ${feat.dip_direct}
                                , Strike: ${feat.strike}<br>
                                Movement sense: <a href="${feat.move_sense_uri}" target="_blank">${feat.move_sense}</a><br>
                                Offset determination: <a href="${feat.offset_det_uri}" target="_blank">${feat.offset_det}</a><br>
                                Reference surface: <a href="${feat.ref_surf_uri}" target="_blank">${feat.ref_surf}</a><br>
                                ${(selConcept.links.length>0)?(`see also: <a href="${selConcept.links.split(';').join('">&nbsp;<i class="fas fa-sm fa-external-link-alt"></i></a><a href="')}">&nbsp;<i class="fas fa-sm fa-external-link-alt"></i></a>`):''}`
                                        )
                                        .bindTooltip(toolTipLabel, {
                                            permanent: showToolTip,
                                            className: "faultLabel",
                                            offset: [0, 0]
                                        });
                                } catch (e) {
                                    alert(e);
                                }
                                $('#loading').hide();
                            });
                        //console.log(data);
                    })
                    .catch(function (err) {
                        alert('too many features to query');//, err);
                    });
                let popup = L.popup();
            });
    </script>
</body>

</html>