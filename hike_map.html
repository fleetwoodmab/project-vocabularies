<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>HIKE Fault Database</title>
    <meta name="" content="">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
    <style>
        @charset "utf-8";

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            background: white;
            outline: 10;
        }

        #info-pane {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 400;
            padding: 1em;
            background: white;
        }

        #getFile {
            position: absolute;
            top: 0px;
            right: 0px;
            height: 70px;
            width: 60px;
            z-index: 500;
            background: rgba(255, 255, 255, 0.7);
            font-family: sans-serif;
            font-size: 11px;
            border: 0px;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            z-index: 1000;
            color: aqua;
            width: 3rem;
            height: 3rem;
        }

        .faultLabel {
            font-size: 10px;
            padding: 0px;
            opacity: 1;
        }

        .leaflet-tooltip {
            background-color: rgba(255, 255, 255, .5);
            border: 1px;
        }

        .popUpText {
            font-size: 70%;
        }

        /* .leaflet-tooltip-left:before {
      right: 0;
      margin-right: -12px;
      border-left-color: rgba(0, 0, 0, 0);
    }

    .leaflet-tooltip-right:before {
      left: 0;
      margin-left: -12px;
      border-right-color: rgba(0, 0, 0, 0);
    } */
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        let urlParams = new URLSearchParams(window.location.search);
        //let USER_LANG = (navigator.language || navigator.language).substring(0, 2);
        let URI = 'https://data.geoscience.earth/ncl/geoera/hike/faults/493';
        if (urlParams.has('uri')) {
            //USER_LANG = urlParams.get('lang');
            URI = decodeURI(urlParams.get('uri').replace(/["';><]/gi, ''));
            //console.log(URI);
        } else {

        }

        let map = L.map('map');

        L.tileLayer.wms('https://ows.mundialis.de/services/service?', {
            'layers': 'OSM-WMS',
            'opacity': '0.6',
            'format': 'image/png',
            'attribution': '&copy; <a href="https://www.mundialis.de">mundialis topo</a>, <a href="https://geoera.eu/projects/hike10/"> / GeoERA - HIKE Fault Database</a>'
        }).addTo(map);

        L.tileLayer.wms('https://egditest01.geus.dk/egdi/wms/', {
            'layers': 'hike_faultdb_overview',
            'mapname': 'hike_preview',
            'transparent': 'true',
            'opacity': '0.4',
            'format': 'image/png'
        }).addTo(map);
        //https://data.geoscience.earth/ncl/geoera/hike/faults/493 periadria, 502 Vienna

        let queryDownLoad = encodeURIComponent(`PREFIX geoera:<https://data.geoscience.earth/ncl/geoera/>
                PREFIX skos:<http://www.w3.org/2004/02/skos/core#>
                SELECT DISTINCT ?uri (coalesce(?d,"") as ?def)
                WHERE {
                <${URI}> skos:narrower* ?uri . 
                optional {?uri skos:definition ?d . filter(lang(?d)='en')}
                }`);

        fetch(`https://resource.geolba.ac.at/PoolParty/sparql/geoera?query=${queryDownLoad}&format=application/json`)
            .then(res => res.json())
            .then(jsonData => {
                //console.log(jsonData.results.bindings.map(a => a.uri.value.split('/').pop()));

                let numbers = jsonData.results.bindings.map(a => [a.uri.value.split('/').pop(), a.def.value]);

                let orPart = (numbers.length > 1) ? ['<ogc:Or>', '</ogc:Or>'] : ['', ''];
                let ogcFilter = `<ogc:Filter>
                          ${orPart[0]}
                            <ogc:PropertyIsEqualTo>
                              <ogc:PropertyName>ms:pv_link</ogc:PropertyName>
                              <ogc:Literal>
                              ${numbers.map(a=>a[0]).join(`</ogc:Literal>
                                  </ogc:PropertyIsEqualTo>
                                  <ogc:PropertyIsEqualTo>
                                    <ogc:PropertyName>ms:pv_link</ogc:PropertyName>
                                <ogc:Literal>`)}
                              </ogc:Literal>
                            </ogc:PropertyIsEqualTo>
                          ${orPart[1]}
                        </ogc:Filter>`;
                ogcFilter = ogcFilter.replace(/\r?\n|\r|\s/g, "");
                //console.log(ogcFilter);

                fetch(
                        `https://egditest01.geus.dk/egdi/wfs/3034/?LAYERS=hike_faultdb_overview_pvtest&SERVICE=WFS&VERSION=1.0.0&REQUEST=GetFeature&TYPENAME=hike_faultdb_overview_pvtest&MAXFEATURES=1000&Filter=${ogcFilter}`
                    )
                    .then(res => res.text())
                    .then(data => {
                        //console.log(data);

                        let parser = new DOMParser(),
                            xmlDoc = parser.parseFromString(data, 'text/xml');

                        let showToolTip = true;
                        let labels = $(xmlDoc).find("ms\\:local_name");
                        if ((labels.length - [...new Set(labels.text().split(' '))].length) > 20) {
                            showToolTip = false;
                        }

                        let ext = $(xmlDoc).find("gml\\:coordinates").first().text().split(' ').map(a => a
                            .split(','));

                        try {
                            let setView = [(parseFloat(ext[0][1]) + parseFloat(ext[1][1])) / 2,
                                (parseFloat(ext[0][0]) + parseFloat(ext[1][0])) / 2
                            ];
                            map.setView(setView, 7);
                        } catch (e) {
                            alert('map data not found');
                        }

                        $(xmlDoc).find("gml\\:featureMember")
                            .find("ms\\:HIKE_FaultDB_Overview_pvTest")
                            .each(function () {
                                let polylinePoints = $(this).find("ms\\:msGeometry")
                                    .find("gml\\:coordinates")
                                    .text().split(' ').map(a => [a.split(',')[1], a.split(',')[0]]);
                                polylinePoints.pop();
                                let toolTipLabel = $(this).find("ms\\:local_name").text();
                                if (toolTipLabel.length > 25) {
                                    toolTipLabel = toolTipLabel.replace(' Fault', '<br>Fault').replace(
                                        ' Subfault', '<br>Subfault');
                                }
                                console.log('ogc_fid: ' + $(this).find("ms\\:ogc_fid").text(),
                                    ' - local_name: ' + $(this).find("ms\\:local_name").text(),
                                    ' - bounds: ' + $(this).find("gml\\:Box").text());

                                let def = '';
                                for (let i of numbers) {
                                    if (i[0] == $(this).find("ms\\:pv_link").text()) {
                                        def = i[1];
                                    }
                                }

                                try {
                                    L.polyline(polylinePoints, {
                                            color: 'red',
                                            //smoothFactor: 1,
                                            weight: 5
                                        }).addTo(map)
                                        .bindPopup(`<h2><a href="${$(this).find("ms\\:projectvocaburi").text()}" target="_blank">
                                  ${$(this).find("ms\\:local_name").text()}
                                </a></h2>
                                ${(def.length>0)?(`<p class="popUpText">${def.substr(0,300)+'..'}</p>`):''}
                                Fault type: <a href="${$(this).find("ms\\:fault_type_uri").text()}" target="_blank">
                                              ${$(this).find("ms\\:fault_type").text()}
                                            </a>
                                , Time: <a href="${$(this).find("ms\\:timing_uri").text()}" target="_blank">
                                        ${$(this).find("ms\\:timing").text()}
                                      </a><br>
                                Observation method: <a href="${$(this).find("ms\\:observ_meth_uri").text()}" target="_blank">
                                                      ${$(this).find("ms\\:observ_meth").text()}
                                                    </a><br>
                                Dip angle: ${$(this).find("ms\\:dip_angle").text()}
                                , Dip direction: ${$(this).find("ms\\:dip_direct").text()}
                                , Strike: ${$(this).find("ms\\:strike").text()}<br>
                                Movement sense: <a href="${$(this).find("ms\\:move_sense_uri").text()}" target="_blank">
                                                ${$(this).find("ms\\:move_sense").text()}
                                                </a><br>
                                Offset determination: <a href="${$(this).find("ms\\:offset_det_uri").text()}" target="_blank">
                                                ${$(this).find("ms\\:offset_det").text()}
                                                </a><br>
                                Reference surface: <a href="${$(this).find("ms\\:ref_surf_uri").text()}" target="_blank">
                                                ${$(this).find("ms\\:ref_surf").text()}
                                                </a><br>`)
                                        .bindTooltip(toolTipLabel, {
                                            permanent: showToolTip,
                                            className: "faultLabel",
                                            offset: [0, 0]
                                        });
                                } catch (e) {
                                    //console.log(e);
                                }
                            });
                        console.log(data);
                    });
                let popup = L.popup();
            });
    </script>
</body>

</html>